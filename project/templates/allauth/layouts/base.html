{% load i18n %}
{% load static %}

<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      {% block head_title %}{% endblock head_title %}
    </title>
    {% block extra_head %}{% endblock extra_head %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="{% static 'scripts/password.js' %}"></script>
  </head>

  <body>
    {% block body %}
    <div class="absolute">
      {% if messages %}
      <div>
        <strong>{% trans "Messages:" %}</strong>
        <ul>
          {% for message in messages %}
          <li>{{ message }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <div>
        <ul>
          {% if user.is_authenticated %}
          <!-- BOTÃO HAMBÚRGUER -->
          <button id="menu-btn"
            class="fixed top-4 right-4 z-[60] flex flex-col justify-between w-9 h-9 items-center p-2.25 hover:bg-[#5463a5] transition rounded-md bg-[#7083D9] focus:outline-none">
            <span class="block h-0.5 w-6 bg-white rounded transition-all duration-300"></span>
            <span class="block h-0.5 w-6 bg-white rounded transition-all duration-300"></span>
            <span class="block h-0.5 w-6 bg-white rounded transition-all duration-300"></span>
          </button>

          <!-- OVERLAY ESCURO -->
          <div id="menu-overlay"
            class="fixed inset-0 bg-black/40 hidden opacity-0 transition-opacity duration-300 z-40"></div>

          <!-- MENU LATERAL -->
          <div id="menu"
            class="fixed top-0 right-0 h-full w-80 bg-[#7083D9] shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 rounded-l-3xl ">
            <div class="p-6 flex flex-col gap-5 text-white font-semibold text-lg">
              <div class="flex items-center gap-5 pb-3">
                <nav class="flex flex-col gap-5 mt-14">
                    {% url 'home' as home %}
                    {% if home %}
                    <li>
                        <a href="{{ home }}" class="flex items-center gap-2 hover:bg-[#6375c7] hover:text-gray-100 transition-colors duration-300 rounded-lg px-2 py-1">
                        <!-- Ícone Página inicial -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875
                                c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504
                                1.125-1.125V9.75M8.25 21h8.25" />
                        </svg>
                        {% trans "Página inicial" %}
                        </a>
                    </li>
                    {% endif %}

                    <!-- CONFIGURAÇÕES (SANFONA) -->
                    <div class="flex flex-col">
                        <button id="settings-btn"
                        class="flex justify-between items-center w-full text-left hover:bg-[#6375c7] hover:text-gray-100
                                transition-colors duration-300 rounded-lg px-2 py-1">
                        <span class="flex items-center gap-2">
                            <!-- Ícone Configurações -->
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398
                                    1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257
                                    1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125
                                    0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723
                                    0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26
                                    1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47
                                    6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213
                                    1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52
                                    6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125
                                    1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0
                                    1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932
                                    6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125
                                    1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0
                                    1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                            {% trans "Configurações" %}
                        </span>
                        <svg id="settings-icon"
                            class="w-5 h-5 transition-transform duration-300"
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 9l-7 7-7-7" />
                        </svg>
                        </button>

                        <div id="settings-menu"
                        class="flex flex-col gap-3 ml-4 overflow-hidden max-h-0 transition-all duration-300">
                        {% url 'account_email' as email_url_ %}
                        {% if email_url_ %}
                        <a href="{{ email_url_ }}" class="text-[15px] hover:bg-[#6375c7] hover:text-gray-100 transition-colors duration-300 rounded-lg px-2 py-1 block mt-3">{% trans "Alterar e-mail" %}</a>
                        {% endif %}

                        {% url 'account_change_password' as change_password_url_ %}
                        {% if change_password_url_ %}
                        <a href="{{ change_password_url_ }}" class="text-[15px] hover:bg-[#6375c7] hover:text-gray-100 transition-colors duration-300 rounded-lg px-2 py-1 block">{% trans "Alterar senha" %}</a>
                        {% endif %}

                        {% url 'socialaccount_connections' as connections_url_ %}
                        {% if connections_url_ %}
                        <a href="{{ connections_url_ }}" class="text-[15px] hover:bg-[#6375c7] hover:text-gray-100 transition-colors duration-300 rounded-lg px-2 py-1 block">{% trans "Conexões de conta" %}</a>
                        {% endif %}
                        </div>
                    </div>

                    <!-- AJUDA E SUPORTE -->
                    <li>
                        <a href="#ajuda" class="flex items-center gap-2 hover:bg-[#6375c7] hover:text-gray-100 transition-colors duration-300 rounded-lg px-2 py-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025
                                1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45
                                1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18
                                0Zm-9 5.25h.008v.008H12v-.008Z" />
                        </svg>
                        {% trans "Ajuda e Suporte" %}
                        </a>
                    </li>

                    <!-- SUGESTÕES E FEEDBACK -->
                    <li>
                        <a href="#feedback" class="flex items-center gap-2 hover:bg-[#6375c7] hover:text-gray-100 transition-colors duration-300 rounded-lg px-2 py-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283
                                3.293.369V21l4.076-4.076a1.526 1.526 0 0 1
                                1.037-.443 48.282 48.282 0 0 0 5.68-.494c1.584-.233
                                2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394
                                48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373
                                3.746 2.25 5.14 2.25 6.741v6.018Z" />
                        </svg>
                        {% trans "Sugestões e Feedback" %}
                        </a>
                    </li>

                    {% url 'account_logout' as logout_url_ %}
                    {% if logout_url_ %}
                    <li>
                        <a href="{{ logout_url_ }}" class="hover:bg-[#6375c7] hover:text-gray-100 transition-colors duration-300 rounded-lg px-2 py-1 block">{% trans "Sair" %}</a>
                    </li>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>
        {% endif %}
        </ul>
      </div>
    </div>

    {% block content %}
    {% endblock content %}

    {# --- Ajuda modal e overlay --- #}
    <div id="help-overlay" class="fixed inset-0 bg-black/50 hidden z-60"></div>
    <div id="help-modal" class="fixed inset-0 flex items-center justify-center hidden z-70">
      <div class="bg-white rounded-lg w-[90%] max-w-lg p-6  shadow-lg">
        <div class="flex items-start justify-between mb-4">
          <h3 class="text-xl font-semibold">Ajuda e Suporte</h3>
          <button id="help-close" class="text-gray-500 hover:text-gray-800" aria-label="Fechar">✕</button>
        </div>
        <div class="text-sm text-gray-700 space-y-3">
          <p><strong>1. Informações detalhadas sobre a coleta: <br></strong>
            Para obter informações detalhadas sobre a coleta de resíduos em um bairro específico, acesse a seção <strong>"Selecione um bairro..."</strong> no Menu Principal e selecione o bairro desejado.
          </p>
          <p><strong>2. Acesso ao Menu Opções: <br></strong>
            Para acessar o Menu Opções, clique no ícone de hambúrguer (três linhas horizontais) localizado no canto superior direito da tela. A partir daí, você pode navegar para diferentes seções do site.
          </p>
          <p><strong>3. Criar um lembrete: <br></strong>
            Crie um alerta personalizado para te lembrar a data e hora da coleta do bairro desejado, selecione a opção <strong>"Crie um alerta para lembrar"</strong>  no Menu Principal e configure o lembrete de acordo com as suas preferências.
          </p>
          <p><strong>4. Contatar o suporte: <br></strong>
           Se precisar de suporte personalizado, envie uma mensagem descrevendo o problema. Iremos responder o mais rápido possível!</p>
          <strong>Contato:</strong> <a href="#feedback" class="text-[#7083D9] hover:text-[#5463a5]"> suporte.deolhonolixo@gmail.com</a></p>
        </div>
        <div class="mt-4 flex justify-end">
          <button id="help-ok" class="px-4 py-2 rounded bg-[#7083D9] text-white hover:bg-[#5463a5]">Fechar</button>
        </div>
      </div>
    </div>

        {# --- Feedback modal e overlay (substitui a versão estática) --- #}
    <div id="feedback-overlay" class="fixed inset-0 bg-black/50 hidden z-60"></div>
    <div id="feedback-modal" class="fixed inset-0 flex items-center justify-center hidden z-70">
      <div class="bg-white rounded-lg w-[90%] max-w-lg p-6 shadow-lg">
        <div class="flex items-start justify-between mb-4">
          <h3 class="text-xl font-semibold">Sugestões e Feedback</h3>
          <button id="feedback-close" class="text-gray-500 hover:text-gray-800" aria-label="Fechar">✕</button>
        </div>

        <form id="feedback-form" class="space-y-3">
          <label class="text-sm block">Avaliação (1 a 5)</label>
          <select id="feedback-rating" name="rating" class="w-full p-2 border rounded">
            <option value="5">5 — Excelente</option>
            <option value="4">4 — Bom</option>
            <option value="3">3 — Regular</option>
            <option value="2">2 — Ruim</option> 
            <option value="1">1 — Péssimo</option>
          </select>

          <label class="text-sm block mt-3">Email de contato</label>
          <input id="feedback-email" name="email" type="email" class="w-full p-2 border rounded" placeholder="contato@exemplo.com" value="contato@exemplo.com">

          <label class="text-sm block mt-3">Mensagem</label>
          <textarea id="feedback-message" name="message" rows="5" class="w-full p-2 border rounded" placeholder="Escreva sua sugestão ou problema..."></textarea>

          <div class="flex justify-end items-center gap-3 mt-2 ">
            <button type="button" id="feedback-cancel" class="px-4 py-2 rounded border hover:bg-[#5463a5]">Cancelar</button>
            <button type="submit" id="feedback-send" class="px-4 py-2 rounded bg-[#7083D9] text-white hover:bg-[#5463a5] ">Enviar</button>
          </div>

          <p id="feedback-status" class="text-sm mt-2 hidden"></p>
        </form>
      </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
        // === MENU LATERAL DIREITO ===
        const btn = document.getElementById('menu-btn');
        const menu = document.getElementById('menu');
        const overlay = document.getElementById('menu-overlay');
        const spans = btn.querySelectorAll('span');

        function toggleMenu() {
            const isOpen = !menu.classList.contains('translate-x-full');
            menu.classList.toggle('translate-x-full');
            overlay.classList.toggle('hidden');
            setTimeout(() => overlay.classList.toggle('opacity-0'), 10);

            // animação do botão (vira X)
            spans[0].classList.toggle('rotate-45');
            spans[0].classList.toggle('translate-y-2');
            spans[1].classList.toggle('opacity-0');
            spans[2].classList.toggle('-rotate-45');
            spans[2].classList.toggle('-translate-y-2');
        }

        btn.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);
        document.querySelectorAll('#menu a').forEach(link => link.addEventListener('click', toggleMenu));

        // === SANFONA DE CONFIGURAÇÕES ===
        const settingsBtn = document.getElementById("settings-btn");
        const settingsMenu = document.getElementById("settings-menu");
        const settingsIcon = document.getElementById("settings-icon");

        if (settingsBtn && settingsMenu && settingsIcon) {
            settingsBtn.addEventListener("click", () => {
            const isClosed = settingsMenu.classList.contains("max-h-0");

            if (isClosed) {
                settingsMenu.classList.remove("max-h-0");
                settingsMenu.classList.add("max-h-40");
                settingsIcon.classList.add("rotate-180");
            } else {
                settingsMenu.classList.remove("max-h-40");
                settingsMenu.classList.add("max-h-0");
                settingsIcon.classList.remove("rotate-180");
            }
            });
        }

        // === Ajuda / Suporte modal handlers ===
        const helpLinks = document.querySelectorAll('a[href="#ajuda"]');
        const helpModal = document.getElementById('help-modal');
        const helpOverlay = document.getElementById('help-overlay');
        const helpCloseBtn = document.getElementById('help-close');
        const helpOkBtn = document.getElementById('help-ok');
 
        function openHelp() {
          helpOverlay.classList.remove('hidden');
          helpModal.classList.remove('hidden');
        }
        function closeHelp() {
          helpOverlay.classList.add('hidden');
          helpModal.classList.add('hidden');
        }
 
        if (helpLinks && helpLinks.length) {
          helpLinks.forEach(el => {
            el.addEventListener('click', (ev) => {
              ev.preventDefault();
              // fechar menu (se aberto) para evitar sobreposição
              if (menu && !menu.classList.contains('translate-x-full')) toggleMenu();
              // abrir modal após pequeno delay para garantir menu fechado
              setTimeout(openHelp, 200);
            });
          });
        }
        helpOverlay.addEventListener('click', closeHelp);
        if (helpCloseBtn) helpCloseBtn.addEventListener('click', closeHelp);
        if (helpOkBtn) helpOkBtn.addEventListener('click', closeHelp);
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeHelp();
        });

        // === Feedback / Suporte modal handlers & envio AJAX ===
        const feedbackLinks = document.querySelectorAll('a[href="#feedback"]');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const feedbackCloseBtn = document.getElementById('feedback-close');
        const feedbackCancelBtn = document.getElementById('feedback-cancel');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackStatus = document.getElementById('feedback-status');

        function getCookie(name) {
          const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
          return v ? v.pop() : '';
        }
        function openFeedback() {
          feedbackOverlay.classList.remove('hidden');
          feedbackModal.classList.remove('hidden');
        }
        function closeFeedback() {
          feedbackOverlay.classList.add('hidden');
          feedbackModal.classList.add('hidden');
          feedbackStatus.classList.add('hidden');
          feedbackStatus.textContent = '';
          feedbackForm.reset();
        }
 
        // Quando o link de contato for clicado (pode estar no menu, footer ou dentro do modal de Ajuda),
        // garantimos que o modal de Ajuda (#help-modal) seja fechado primeiro para evitar overlays duplos.
        if (feedbackLinks && feedbackLinks.length) {
          feedbackLinks.forEach(el => {
            el.addEventListener('click', (ev) => {
              ev.preventDefault();
              // fechar menu lateral se estiver aberto
              if (menu && !menu.classList.contains('translate-x-full')) toggleMenu();

              // Se o help modal estiver aberto, fechá-lo antes de abrir feedback
              const helpIsOpen = typeof helpModal !== 'undefined' && helpModal && !helpModal.classList.contains('hidden');
              if (helpIsOpen) {
                closeHelp(); // fecha help overlay/modal
                // aguardar pequeno delay para garantir que overlay foi removido visualmente
                setTimeout(openFeedback, 200);
              } else {
                // abrir feedback normalmente
                setTimeout(openFeedback, 120);
              }
            });
          });
        }
        feedbackOverlay.addEventListener('click', closeFeedback);
        if (feedbackCloseBtn) feedbackCloseBtn.addEventListener('click', closeFeedback);
        if (feedbackCancelBtn) feedbackCancelBtn.addEventListener('click', closeFeedback);
 
        feedbackForm.addEventListener('submit', (e) => {
         e.preventDefault();
         feedbackStatus.classList.remove('hidden');
         feedbackStatus.textContent = 'Enviando...';
 
         const payload = {
           rating: document.getElementById('feedback-rating').value,
           email: document.getElementById('feedback-email').value,
           message: document.getElementById('feedback-message').value
         };
 
         fetch("{% url 'feedback' %}", {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
             'X-CSRFToken': getCookie('csrftoken')
           },
           body: JSON.stringify(payload)
         })
         .then(r => r.json())
         .then(json => {
           if (json.success) {
             feedbackStatus.textContent = 'Mensagem enviada. Obrigado!';
             setTimeout(closeFeedback, 1200);
           } else {
             feedbackStatus.textContent = 'Erro: ' + (json.error || 'Não foi possível enviar');
           }
         }).catch(err => {
           feedbackStatus.textContent = 'Erro: ' + (err.message || err);
         });
       });
       // === fim feedback ===
        });
        </script>

    {% endblock body %}
    {% block extra_body %}{% endblock extra_body %}
  </body>
</html>
