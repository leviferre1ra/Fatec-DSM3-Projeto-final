{% extends "allauth/layouts/base.html" %}

{% block content %}

<div class="m-0 font-[Inter] font-bold grid grid-cols-[450px_1fr] bg-white box-border">

  <!-- Painel lateral esquerdo -->
  <aside class="bg-white flex flex-col p-[30px] overflow-y-scroll max-h-screen py-9 scrollbar shadow-[10px_0px_6px_rgba(0,0,0,0.15)] z-[2]">

    <!-- Perfil -->
    <div class="flex items-center gap-[10px] mb-[35px]">
      <img src="https://via.placeholder.com/45" alt="Foto do usuário"
           class="w-[65px] h-[65px] rounded-full object-cover border-[2.3px] border-black">
      <span class="font-medium text-black text-[1.2rem]">{{ user.first_name|default:user.username }}</span>
    </div>

    <!-- Modal de seleção de bairro -->
    <div class="bg-white p-8 rounded-lg max-w-md text-center">
        <select id="dropdown-bairros" class="w-full p-3 mb-6 border border-gray-300 rounded-lg text-lg focus:ring-[#7083D9] focus:border-[#7083D9]">
            <option value="" disabled selected>Escolha um bairro...</option>
            <option value="todos">Todos</option>
            <option value="Anhanguera">Anhanguera</option>
            <option value="Antartica">Antártica</option>
            <option value="Aviacao">Aviação</option>
            <option value="Boqueirao">Boqueirão</option>
            <option value="Caicara">Caiçara</option>
            <option value="Canto do Forte">Canto do Forte</option>
            <option value="Cidade da Crianca">Cidade da Criança</option>
            <option value="Esmeralda">Esmeralda</option>
            <option value="Florida">Flórida</option>
            <option value="Gloria">Glória</option>
            <option value="Guilhermina">Guilhermina</option>
            <option value="Maracana">Maracanã</option>
            <option value="Melvi">Melvi</option>
            <option value="Mirim">Mirim</option>
            <option value="Nova Mirim">Nova Mirim</option>
            <option value="Ocian">Ocian</option>
            <option value="Princesa">Princesa</option>
            <option value="Quietude">Quietude</option>
            <option value="real">Real</option>
            <option value="Ribeiropolis">Ribeirópolis</option>
            <option value="Samambaia">Samambaia</option>
            <option value="Santa Marina">Santa Marina</option>
            <option value="Sitio do Campo">Sítio do Campo</option>
            <option value="Solemar">Solemar</option>
            <option value="Tupi">Tupi</option>
            <option value="Tupiry">Tupiry</option>
            <option value="vila sonia">Vila Sônia</option>
        </select>
    </div>


    <!-- Contagem regressiva -->
    <div class="text-center mb-[18px]">
      <h2 class="m-0 text-black font-semibold text-[1.5rem]">A coleta começa em:</h2>
      <h1 class="text-[6.5rem] text-[#7083D9] font-bold m-0">00:47</h1>
    </div>

    <!-- Próxima coleta -->
    <div class="bg-[#7083D9] text-white rounded-[10px] p-4 text-center mb-[23px] shadow-[10px_10px_5px_rgba(0,0,0,0.15)] z-[3]">
      <p class="m-[5px_3px] text-[1.3rem] font-normal"><strong>Próxima Coleta:</strong> 28/09/2025</p>
      <p class="m-[5px_3px] text-[1.3rem] font-normal"><strong>Horário Previsto:</strong> 14:00</p>
    </div>

    <!-- Alerta -->
    <div class="text-center mb-[25px]">
      <h2 class="m-0 text-black font-semibold text-[1.5rem]">Perdeu o horário da coleta?</h2>
      <a href="#" class="text-[#7083D9] no-underline font-semibold text-[1.2rem] hover:underline">Crie um alerta para lembrar</a>
    </div>

  <!-- Últimas coletas -->
  <div class="w-full mb-[25px] flex justify-center">
    <div class="bg-[#ffb84d] text-[#4e4e4e] text-[1rem] rounded-[10px] p-[14px]
      shadow-[10px_10px_5px_rgba(0,0,0,0.15)] z-[3] text-center
      mx-auto w-full">

      <h3 class="text-black m-0 mb-[8px] text-[1.1rem]">Últimas coletas</h3>

      <ul class="list-none m-0 px-[6px] text-[#4e4e4e]">
        <li class="py-[4px] font-medium border-b border-dashed border-[rgba(0,0,0,0.06)]">21/09/2025</li>
        <li class="py-[4px] font-medium border-b border-dashed border-[rgba(0,0,0,0.06)]">13/09/2025</li>
        <li class="py-[4px] font-medium border-b border-dashed border-[rgba(0,0,0,0.06)]">06/09/2025</li>
        <li class="py-[4px] font-medium border-b border-dashed border-[rgba(0,0,0,0.06)]">01/08/2025</li> 
      </ul>
    </div>
  </div>


      <!-- Rodapé -->
    <footer class="text-center text-[0.9rem] font-semibold text-[#4e4e4e]">
      Precisa de ajuda? <a href="#" class="text-[#7083D9] no-underline hover:underline">Clique aqui</a>
    </footer>
  </aside>

  <!-- Mapa -->
  <main class="w-full h-full z-[1]">
    <div id="map" class="w-full h-screen"></div>
  </main>

</div>

<!-- Leaflet CSS e JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  let map;
  let geoJsonLayer;
  let bairroSelecionado = localStorage.getItem('bairroSelecionado') || '';
  let initialGeojson = null;
  // Dia atual (passado do backend)
  const diaAtual = "{{ dia_atual|escapejs }}";

  // Inicializar mapa
  function inicializarMapa() {
    map = L.map('map').setView([-24.0053, -46.4124], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    geoJsonLayer = L.geoJSON(null, {
      style: function(feature) {
        const props = feature.properties || {};
        const dias = Array.isArray(props.Dias) ? props.Dias : [];
        const isActive = dias.includes(diaAtual);
        return {
          color: isActive ? '#7083D9' : '#A6A6A6',
          weight: 2,
          opacity: 0.8,
          fillOpacity: 0.3,
          fillColor: isActive ? '#7083D9' : '#A6A6A6'
        };
      },
      onEachFeature: function(feature, layer) {
        const props = feature.properties || {};
        const diasArray = Array.isArray(props.Dias) ? props.Dias : [];
        const dias = diasArray.join(', ');
        const popupContent = `
          <div class="popup-content">
            <b>${props.Bairro}</b><br>
            <strong>Dias:</strong> ${dias}<br>
            <strong>Período:</strong> ${props.Período}<br>
            <strong>Horário:</strong> ${props.Horário}
          </div>
        `;
        layer.bindPopup(popupContent);
      }
    }).addTo(map);
  }

  // Calcular centro e bounds das features
  function centralizarNoMapa(geojsonData) {
    if (!geojsonData || !geojsonData.features || geojsonData.features.length === 0) {
      return;
    }

    const bounds = L.geoJSON(geojsonData).getBounds();
    map.fitBounds(bounds, { padding: [50, 50] });
  }

  // Carregar dados do GeoJSON inicial
  function carregarGeojson(geojsonData) {
    if (geoJsonLayer) {
      geoJsonLayer.clearLayers();
      geoJsonLayer.addData(geojsonData);
    }
    centralizarNoMapa(geojsonData);
  }

  // Listener para mudança no dropdown
  document.getElementById('dropdown-bairros').addEventListener('change', function() {
    const bairro = this.value;

    if (!bairro) {
      return;
    }

    // Caso especial: mostrar todos os bairros (restaurar visão completa)
    if (bairro === 'todos') {
      localStorage.removeItem('bairroSelecionado');
      if (initialGeojson) {
        carregarGeojson(initialGeojson);
        console.log('Mostrando todos os bairros');
      }
      return;
    }

    // Salvar bairro selecionado no localStorage
    localStorage.setItem('bairroSelecionado', bairro);

    // Fazer requisição AJAX
    fetch(`/api/carregar-bairro/?bairro=${encodeURIComponent(bairro)}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          carregarGeojson(data.geojson);
          console.log('Bairro carregado:', bairro);
        } else {
          console.error('Erro ao carregar bairro:', data.error);
        }
      })
      .catch(error => console.error('Erro:', error));
  });

  // Inicializar na primeira carga
  document.addEventListener('DOMContentLoaded', function() {
    inicializarMapa();
    
    // Dados GeoJSON passados do backend
    initialGeojson = {{ geojson|safe }};
    carregarGeojson(initialGeojson);

    // Restaurar bairro selecionado do localStorage
    const dropdown = document.getElementById('dropdown-bairros');
    if (bairroSelecionado) {
      dropdown.value = bairroSelecionado;
    } else {
      // por padrão, mostrar todos
      dropdown.value = 'todos';
    }
  });
</script>

{% endblock content %}